<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Google Sans', 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 12px;
      opacity: 0.9;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      background: #667eea;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.bot {
      background: white;
      color: #333;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .message.system {
      background: #fff3cd;
      color: #856404;
      align-self: center;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 12px;
      text-align: center;
      max-width: 100%;
    }

    .event-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin: 8px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      border-left: 4px solid #667eea;
    }

    .event-card h3 {
      font-size: 14px;
      color: #333;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .event-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .event-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 12px;
      background: #f0f0f0;
      color: #555;
      display: inline-block;
    }

    .event-badge.date {
      background: #e8f4fd;
      color: #0066cc;
    }

    .event-badge.location {
      background: #fff3e0;
      color: #e65100;
    }

    .event-badge.status {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .event-badge.format {
      background: #f3e5f5;
      color: #6a1b9a;
    }

    .event-description {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
      line-height: 1.4;
    }

    .event-link {
      display: inline-block;
      margin-top: 8px;
      font-size: 12px;
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
    }

    .event-link:hover {
      text-decoration: underline;
    }

    .quick-filters {
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #e0e0e0;
    }

    .quick-filters-title {
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .filter-btn {
      padding: 6px 12px;
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 16px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      color: #555;
    }

    .filter-btn:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .input-container {
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 8px;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    #queryInput {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    #queryInput:focus {
      border-color: #667eea;
    }

    #sendBtn {
      padding: 10px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    #sendBtn:hover {
      background: #5568d3;
    }

    #sendBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .typing-indicator {
      display: none;
      padding: 10px 14px;
      background: white;
      border-radius: 16px;
      align-self: flex-start;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #999;
      margin-right: 4px;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    .export-btn {
      display: inline-block;
      padding: 8px 16px;
      background: #34a853;
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }

    .export-btn:hover {
      background: #2d8e47;
    }

    .welcome-message {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .welcome-message h2 {
      font-size: 16px;
      margin-bottom: 8px;
      color: #333;
    }

    .welcome-message p {
      font-size: 13px;
      line-height: 1.5;
    }

    .example-queries {
      margin-top: 16px;
      text-align: left;
      background: white;
      padding: 12px;
      border-radius: 8px;
    }

    .example-queries h4 {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .example-queries ul {
      list-style: none;
      font-size: 12px;
      color: #667eea;
    }

    .example-queries li {
      padding: 4px 0;
      cursor: pointer;
    }

    .example-queries li:hover {
      text-decoration: underline;
    }

    .example-queries li:before {
      content: "üí¨ ";
      margin-right: 4px;
    }

    .results-count {
      text-align: center;
      padding: 8px;
      font-size: 12px;
      color: #666;
      background: #f9f9f9;
      border-radius: 8px;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üí¨ Training Search</h1>
    <p>Ask me about upcoming trainings</p>
  </div>

  <div class="chat-container" id="chatContainer">
    <div class="welcome-message">
      <h2>üëã Hello!</h2>
      <p>I can help you find training events. Try asking:</p>
      <div class="example-queries">
        <h4>Example Questions:</h4>
        <ul>
          <li onclick="sendQuery('What trainings are happening this week?')">What trainings are happening this week?</li>
          <li onclick="sendQuery('Show me business planning events')">Show me business planning events</li>
          <li onclick="sendQuery('Online trainings in Oakland')">Online trainings in Oakland</li>
          <li onclick="sendQuery('Marketing trainings next month')">Marketing trainings next month</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="quick-filters">
    <div class="quick-filters-title">Quick Filters</div>
    <div class="filter-buttons">
      <button class="filter-btn" onclick="sendQuery('trainings this week')">This Week</button>
      <button class="filter-btn" onclick="sendQuery('trainings this month')">This Month</button>
      <button class="filter-btn" onclick="sendQuery('online trainings')">Online</button>
      <button class="filter-btn" onclick="sendQuery('business planning')">Business Plan</button>
      <button class="filter-btn" onclick="sendQuery('marketing trainings')">Marketing</button>
      <button class="filter-btn" onclick="sendQuery('startup trainings')">Start-up</button>
    </div>
  </div>

  <div class="input-container">
    <div class="input-wrapper">
      <input
        type="text"
        id="queryInput"
        placeholder="Ask about trainings..."
        onkeypress="handleKeyPress(event)"
      >
    </div>
    <button id="sendBtn" onclick="sendMessage()">Send</button>
  </div>

  <script>
    let lastResults = [];

    function addMessage(text, type = 'bot') {
      const container = document.getElementById('chatContainer');
      const message = document.createElement('div');
      message.className = 'message ' + type;
      message.textContent = text;
      container.appendChild(message);
      scrollToBottom();
    }

    function addEventCards(events) {
      const container = document.getElementById('chatContainer');

      if (events.length > 0) {
        const countDiv = document.createElement('div');
        countDiv.className = 'results-count';
        countDiv.textContent = `Found ${events.length} training event${events.length === 1 ? '' : 's'}`;
        container.appendChild(countDiv);
      }

      events.forEach(event => {
        const card = document.createElement('div');
        card.className = 'event-card';

        let html = `<h3>${event.title}</h3>`;

        html += '<div class="event-meta">';
        if (event.date) {
          html += `<span class="event-badge date">üìÖ ${event.date}</span>`;
        }
        if (event.location) {
          html += `<span class="event-badge location">üìç ${event.location}</span>`;
        }
        if (event.status) {
          html += `<span class="event-badge status">${event.status}</span>`;
        }
        if (event.format) {
          html += `<span class="event-badge format">${event.format}</span>`;
        }
        if (event.hours) {
          html += `<span class="event-badge">${event.hours} hours</span>`;
        }
        html += '</div>';

        if (event.description) {
          html += `<div class="event-description">${event.description}</div>`;
        }

        if (event.signupUrl) {
          html += `<a class="event-link" href="${event.signupUrl}" target="_blank">Register ‚Üí</a>`;
        }

        card.innerHTML = html;
        container.appendChild(card);
      });

      if (events.length > 0) {
        const exportBtn = document.createElement('button');
        exportBtn.className = 'export-btn';
        exportBtn.textContent = 'üìä Export to Sheet';
        exportBtn.onclick = exportToSheet;
        container.appendChild(exportBtn);
      }

      scrollToBottom();
    }

    function showTyping() {
      const container = document.getElementById('chatContainer');
      const typing = document.createElement('div');
      typing.className = 'typing-indicator';
      typing.id = 'typingIndicator';
      typing.innerHTML = '<span></span><span></span><span></span>';
      typing.style.display = 'block';
      container.appendChild(typing);
      scrollToBottom();
    }

    function hideTyping() {
      const typing = document.getElementById('typingIndicator');
      if (typing) typing.remove();
    }

    function scrollToBottom() {
      const container = document.getElementById('chatContainer');
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    }

    function sendMessage() {
      const input = document.getElementById('queryInput');
      const query = input.value.trim();

      if (!query) return;

      sendQuery(query);
      input.value = '';
    }

    function sendQuery(query) {
      const sendBtn = document.getElementById('sendBtn');
      const queryInput = document.getElementById('queryInput');

      // Add user message
      addMessage(query, 'user');

      // Disable input
      sendBtn.disabled = true;
      queryInput.disabled = true;

      // Show typing indicator
      showTyping();

      // Call Google Apps Script
      google.script.run
        .withSuccessHandler(function(result) {
          hideTyping();
          sendBtn.disabled = false;
          queryInput.disabled = false;

          if (result.success) {
            if (result.count > 0) {
              lastResults = result.events;
              addEventCards(result.events);
            } else {
              addMessage(result.message, 'bot');
              addMessage('Try adjusting your search criteria or date range.', 'bot');
            }
          } else {
            addMessage(result.message, 'bot');
          }
        })
        .withFailureHandler(function(error) {
          hideTyping();
          sendBtn.disabled = false;
          queryInput.disabled = false;
          addMessage('Sorry, I encountered an error: ' + error.message, 'bot');
        })
        .searchTrainings(query);
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    function exportToSheet() {
      if (lastResults.length === 0) {
        addMessage('No results to export.', 'system');
        return;
      }

      addMessage('Exporting to sheet...', 'system');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            addMessage(result.message, 'system');
          } else {
            addMessage('Error: ' + result.message, 'system');
          }
        })
        .withFailureHandler(function(error) {
          addMessage('Export failed: ' + error.message, 'system');
        })
        .exportEventsToSheet(lastResults);
    }

    // Focus input on load
    window.onload = function() {
      document.getElementById('queryInput').focus();
    };
  </script>
</body>
</html>
